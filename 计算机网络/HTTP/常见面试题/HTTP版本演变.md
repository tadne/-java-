# HTTP版本演变

### HTTP/1.1的改进

HTTP/1.1: HTTP->TCP->IP->MAC

HTTP/1.1的改进

- 使用长链接改善了短连接造成的性能开销
- 支持管道网络传输，一个请求发出不用等其回来就能发第二个请求

HTTP/1.1的性能问题：
- 请求、响应头部未经压缩就发送，首部信息越多延迟越大，只能压缩Body部分
- 发送冗长的首部，每次交互发送相同的首部浪费较多
- 服务器响应是按照请求的顺序响应，如果服务器响应慢会导致对头阻塞
- 没有请求优先级控制
- 请求只能从客户端开始，服务器被动响应

### HTTP/2的改进
HTTP/2: HTTP->HPack、Stream->TLS 1.2+->TCP->IP->MAC

HTTP/2的改进

- HTTP/2协议是基于HTTPS的，安全性有保障
- 头部压缩
- 二进制格式
- 并发传输
- 服务器主动推送资源
  
1. 头部压缩： HTTP/2会压缩头，如果同时发送多个一样或相似的请求头的请求，协议会采用HPack算法消除重复部分。
   - HPack算法： 在客户端和服务器维护一张头信息表，所有字段存在表中，生成一个索引号，以后不发送同样字段了，只发送索引号，提高速度。
  
2. 二进制格式：HTTP/2不像是HTTP/1.1那样采用纯文本格式报文，而是全部采用二进制格式，头信息和数据体都是二进制，统称为帧： 头信息帧和数据帧。 这样计算机收到报文后就直接解析二进制，提高传输效率。

3. 并发传输： 
   - HTTP/1.1基于请求-响应模型。同一个链接中，HTTP完成一个事务，才能出来下一个。也就是在请求后只能等待响应。如果迟迟没有收到响应就会阻塞。
   - HTTP/2引入Stream，多个Stream复用一条TCP链接。一个TCP链接包含多个Stream，Stream里包含1个或多个Message，Message对应HTTP/1.1中的请求或响应，由HTTP头部和包体构成。Message里包含一条或多个Frame，Frame是HTTP/2最小单位，以二进制压缩格式HTTP/1中的内容。
   - 针对不同的HTTP请求用独一无二的StreamID来区分，接受端可以通过StreamID有序组装成HTTP消息，不同Stream的帧可以乱序发送，因此可以并发不同的Stream，也就是可以并行交错发送请求和响应

4. 服务器推送：
   - HTTP/2改善了请求-响应模式，服务端不再被动响应，还可以主动向客户端发消息
   - 也就是客户端和服务器双方都可以建立Stream，streamID是有区别的，客户端必须是奇数，服务端必须是偶数。
   - 例： HTTP/1.1，向服务器请求HTML和CSS渲染的时候，必须两个请求，两个来回。但HTTP/2可以只发一个请求到服务器请求HTML，而服务器响应两个信息。
  
HTTP/2的缺陷
- HTTP/2通过Strean的并发能力解决了队头阻塞，但是HTTP/2还是有"队头阻塞"问题，只不过是不在应用层了，而是TCP传输层。
  - 因为HTTP/2是基于TCP协议传输数据，TCP是字节流协议，TCP必须保证数据完整连续才能让内核讲缓冲区的数据返回HTTP应用，那么只要数据没有全部抵达，就只能存在缓冲区中。而且如果中间出现了丢包问题，就会等待更久。

### HTTP/3的改进
HTTP/1.1和HTTP/2都有队头阻塞问题：
- HTTP/1.1管道解决了请求的队头阻塞，但是没有解决响应的队头阻塞，因为服务端要按照顺序响应收到的请求。
- HTTP/2通过多个请求复用TCP解决HTTP的队头阻塞，但是一旦丢包，会阻塞所有HTTP请求，出现TCP层队头阻塞

HTTP/2阻塞是因为TCP，所以**HTTP/3将HTTP下层的TCP改为了UDP**。

UDP发送不管顺序，不管丢包，所以不会出现队头阻塞，不管虽然UDP是不可靠传输，但是基于UDP的QUIC协议可以实现TCP可靠传输。

QUIC特点：
- 无队头阻塞
- 更快的连接建立
- 连接迁移

1. 无队头阻塞
   - 问题：HTTP/1有响应队头阻塞问题，HTTP/2有TCP层队头阻塞问题。
   - 解决
      1. QUIC协议类似HTTP/2 Strean和多路复用的概念，可以在同一个连接上并发传输多个Stream，Stream可以认为是一条HTTP请求。
      2. QUIC有一套机制保证传输的可靠性。当某个Stream发生丢包，只会阻塞这个流，其他流不会受到影响，所以没有队头阻塞问题。
      3. 因此，QUIC连接上的多个Stream间没有依赖，各自独立。
2. 更快的连接建立
   - 问题：HTTP/1和HTTP/2的TCP和TLS是分层的，分别属于内核试下的传输层、openssl库实现的表示层，因此难以合并在一起，要分批次握手，先TCP握手，再TLS握手
   - 解决：
     1. HTTP/3的传输数据需要QUIC协议握手，但是握手过程只要1RTT,握手是为了确认双方的连接ID，连接迁移就是基于连接ID实现的。
     2. QUIC内部包含了TLS，在自己的帧中携带TLS里的记录，加上QUIC使用的是TLS/1.3，只要1个RTT就可以完成建立连接和密钥协商
     3. 甚至，在第二次连接的时候，应用数据包可以和QUIC握手信息一起发送，达到0-RTT效果
3. 连接迁移
   - 问题： 基于TCP传输的HTTP协议是通过四元组（本地IP，本地端口，目的IP，目的端口）确定TCP连接。当设备忘了改变时，IP就变了，就要断开连接重新建立连接。而建立连接的过程包含TCP三次握手和TLS四次握手时延，以及TCP慢启动的减速过程，会卡顿。
    - 解决
        1. QUIC没有使用四元组，而是通过连接ID标记通信的两个端点，客户端和服务器可以各自选择一组ID来标记自己。即使设备网络变化IP改变，只要还留有上下文信息，就可以无缝复用原连接，消除重连成本，没有卡顿。实现连接迁移
        2. QUIC是UDP上的伪TCP+TLS+HTTP/2的多路复用协议。QUIC是新协议，很多设备无法识别，只能识别为UDP协议，而有的设备会丢掉UDP包，也就导致普及很慢。
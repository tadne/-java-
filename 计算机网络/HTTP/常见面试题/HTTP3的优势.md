# HTTP3

HTTP3现在已经推出可用，比如虾皮、知乎等都有使用HTTP3。

## HTTP2的问题：
- 队头阻塞：tcp层的队头阻塞
  - HTTP2请求跑在一个TCP连接中，TCP丢包的时候，整个TCP都要等待重传，阻塞整个HTTP的请求。因为**TCP协议要保证消息连续完整**，不然应用层在内核读取不到
- TCP和TLS的握手延时
  - HTTP请求要经过TCP三次握手，TLS四次握手，要3RTT延时才能发送请求数据
  - TCP还有拥塞控制的特性，刚建立连接的TCP有慢启动的过程，会对TCP连接有减速效果
- 网络迁移需要重新连接
  - TCP连接基于四元组（源IP，源端口，目标IP，目标端口），如果IP变动了，导致TCP和TLS握手，不利于设备切换网络。如4G切wifi

## QUIC特点

UDP是一个简单、不可靠传输协议，UDP之间无序没有依赖关系，UDP不需要连接。

HTTP3基于UDP协议在应用层实现了QUIC协议，它有类似TCP的链接管理、拥塞窗口、流量控制等特点，将不可靠转换为了可靠

QUIC优点：
1. 无队头阻塞
   - QUIC还是由HTTP2的Stream与多路复用的概念，可以在同一条连接上并发传输多个Stream，Stream可以认为是一个HTTP请求
   - QUIC使用UDP传输，不关心丢包问题，这样就解决了HTTP2的TCP层队头阻塞问题
   - QUIC协议保证数据包可靠性，数据表有唯一标识，丢包的时候即使包到达了数据依然无法被读取，直到QUIC重传数据包
   - QUIC上的Stream之间没有依赖都是相互独立的，一个流丢包不会影响其他流
2. 更快建立连接
   - 问题：对于HTTP1和HTTP2协议，TCP和TLS是分层的，分别属于内核的传输层和OpenSSL库的表示层难以合并要分批次握手。
   - HTTP3在传输数据前要QUIC握手，但是握手只要1RTT，握手是为了确认双方连接ID，连接迁移基于此实现
   - QUIC协议不是和TLS分层，而是**QUIC内部包含TLS，加上QUIC使用的是TLS1.3,只需要1RTT就可以完成连接建立和密钥协商，甚至第二次连接时就可以将数据和QUIC握手信息一起发送，达到0RTT的效果**
3. 连接迁移
   - 问题：基于TCP的HTTP协议是通过四元组确定TCP连接，当网络切换就意味着IP改变，要重新建立连接。这个过程包含TCP三次握手、TLS四次挥手、TCP慢启动过程
   - QUIC是通过连接ID标记通信的端点，即使网络变更，只要上下文信息还在就可以无缝重连

### HTTP3协议
HTTP3相比于HTTP2在应用层的变化：
- HTTP3同样使用二进制帧结构，但是HTTP2的二进制帧中要定义Stream，HTTP3自身不需要定义Stream，直接用QUIC中的Stream。
- HTTP3帧头只有两个字段： 类型和长度
  - 大体分为数据帧和控制帧，Headers帧（头部）和DATA帧（包体）属于数据帧。
- HTTP3在头部压缩算法中进行了升级，升级为QPACK，还是采用静态表、动态表、Huffman编码。
  - 静态表扩大到了91项
  - Huffman变化不大
  - 动态表
    - 问题：动态表就是在首次请求-响应后，将未包含在静态表中的头信息更新到动态表并缓存，不必在传输中传递，提高编码效率
      - 其中**动态表是由时序性的，如果首次请求丢包，后续请求对方就无法解码HPACK头了，因为没有建立好动态表，后续的请求都会阻塞重传
    - HTTP3解决：
      - QUIC由两个特殊单向流，单向流就是只有一端发送消息。
        - QPACKEEncoderStream：用于将一个字典传递给对方，如不属于静态表的HTTP头部，客户端可以通过这个Stream发字典
        - QPACKDecoderStream：用于响应对方，告诉它刚发的字典已经更新自己的本地动态表，后续可以使用这个字典编码
      - 两个流式用来同步双方动态表，编码放收到解码方更新的通知后，才使用动态表编码HTTP头部

### 总结
HTTP2有并发传输能力，但是被TCP限制了。
HTTP2的缺陷：队头阻塞怕丢包、TCP和TLS握手延时、连接迁移要重连

HTTP3特点： **将传输层TCP协议换成了UDP协议，在UDP协议上开发了QUIC协议保证数据可靠传输**
QUIC协议特点：**无队头阻塞、建立连接快、连接迁移**，另通过两个单向流解决动态表同步问题

# HTTP和HTTPS

## HTTP和HTTPS的区别

- HTTP是超文本传输协议,信息明文传输，有安全问题。HTTPS解决HTTP不安全缺陷，在TCP、HTTP间的网络层加入了SSL/TLS安全协议，使报文可以加密传输
- HTTP连接建立简单，TCP三次握手后便可进行HTTP报文传输，而HTTPS在TCP三次握手后还要进行SSL/SSL握手过程才能进行加密报文传输
- HTTP默认端口是80，HTTPS默认端口是443。
- HTTPS要向CA（权威机构）申请数字证书，来保证服务器身份可信

## HTTPS解决了HTTP的哪些问题

#### HTTP的问题

- 窃听，在通信链路上可以获取通信内容
- 篡改，别强制植入垃圾广告
- 冒充，冒充淘宝等网站

HTTPS在HTTP应用层与TCP传输层中间的网络层加了SSL/TLS协议解决上述问题。

#### HTTPS的特性

- 信息加密： 交互信息无法被窃取
- 校验机制： 无法篡改通信内容，篡改导致无法正常显示
- 身份证书： 证明网站真实性

#### HTTPS的解决方式

- 混合加密方式： 实现信息的机密性，解决窃听
- 摘要算法：实现完整性，能为数据生成唯一指纹，用于校验数据的完整性，解决篡改
- 将服务器公钥放到数字证书中完成身份验证

##### 混合加密

HTTPS采用**对称加密**和**非对称加密**的混合加密方式

- 在通信前采用非对称加密方式交换会话秘钥，后续不再使用非对称加密
- 通信过程中全部使用对称加密的【会话秘钥】方式加密明文数据

采用混合加密的原因：

- 对称加密只有一个密匙，运算速度快，密匙必须交换，无法保证安全
- 非对称加密有两个密匙，公匙和私匙，公匙可以任意分发，私匙保密，解决了密匙交换速度慢

##### 摘要算法+数字签名

为了保证传输的内容不被篡改，要对内容计算一个指纹，再同内容发送给对方，对方收到后，再次计算指纹与发来的指纹进行对比，指纹相同就说明没有被篡改

计算机中会使用摘要算法（哈希函数）计算内容哈希值，这个哈希值唯一且无法通过哈希值推导内容

哈希算法可以确保内容不被篡改，但是**不能保证内容+哈希值不会被其他人替换，因为缺少对客户端收到的消息来着服务端的证明**

为了避免这种情况，会采用非对称加密解决，公钥广发，私钥本人管理，两个密钥双向解密，公钥加密私钥解密、私钥加密公钥解密

- 公钥加密私钥解密： 保护内容传输安全，只有持有私钥的人才能解密
- 私钥加密公钥解密： 保证消息不被冒充。私钥不可泄露，公钥能正常解密私钥加密的内容说明消息来源于持有私钥的人

但是一般不使用非对称加密实际传输内容，因为非对称加密计算比较耗费性能。非对称加密主要通过【私钥加密，公钥解密】的方式确认消息的身份，数字签名算法就是采用这种方式，不过私钥加密的内容不是内容本身，而是对内容的哈希值进行加密

- 私钥由服务端保管，服务端对客户端发送公钥，客户端收到的消息如果能被公钥解密，说明消息是服务器发送的

##### 数字证书

前面可知：

- 哈希算法保证数据的完整性
- 数字签名保证消息来源的可靠性

但是还缺少身份验证环节，因为可以同时伪造一对公私钥，比如可以偷偷将服务端的公钥替换，服务端不知情的情况下就会导致模拟请求了。

这时就需要一个权威机构CA（数字证书认证机构），将服务器公钥放在数字证书中，只要证书可信，公钥就可信

流程：

- 服务器将公钥注册到CA
- CA用自己的私钥将服务器的公钥数字签名并颁发数字证书
- 客户端拿到服务器的数字证书后，使用CA的公钥确认服务器数字证书的真实性
- 从数字证书获取服务器公钥后，用它对报文加密后发送
- 服务器用私钥对报文解密

## HTTPS是如何建立连接？交互了什么？

SSL/TLS协议流程：

- 客户端向服务器所有公钥
- 双方协商生产【会话秘钥】
- 双方采用【会话密钥】进行加密通信

前两步就是SSL/TLS的建立过程，也就是TLS握手过程

TLS握手涉及四次通信，用不同的密匙交换算法，TLS握手流程也不同，现在常用密匙交换算法有两种：RSA算法和ECDHE算法

基于RSA算法的TLS握手过程比较容易理解，

流程：

- 客户端向服务器发送加密通信请求，也就是ClientHello

  - 客户端支持的TLS协议版本，如TLS1.2版本
  - 客户端生产的随机数【ClientRandom】，后面用于生成【会话秘钥】
  - 客户端支持的密码套件列表，如RSA加密算法
- 服务器收到客户端请求后，向客户端发出响应，也就是SeverHello,服务器回应：

  - 确认TLS协议版本，如果浏览器不支持，关闭加密通信
  - 服务器生产的随机数（ServerRandom），也是后面用于生产【会话秘钥】条件之一
  - 确认的密码套件列表，如RSA加密算法
  - 服务器的数字证书
- 客户端收到服务器响应后，通过浏览器或操作系统中的CA公钥，确认数字证书真实性，如果证书没问题，客户端就会从数字证书中取出服务器公钥，用它加密报文，向服务器发送消息

  - 一个随机数，随机数会被服务器公钥加密
  - 加密通信算法改变通知，表示随后信息都将用会话秘钥加密通信
  - 客户端握手结束通知，表示客户单握手阶段结束，同时将之前内容发生的数据做个摘要，供服务器校验
  - 服务器和客户端有了 （ClientRandom、ServerRandom、pre-masterkey）,接着就用双方协商的加密算法，生成本次通信的会话秘钥
- 服务器收到客户端的第三个随机数后，通过协商的加密算法，计算出本次通信的【会话秘钥】，返回：

  - 加密通信算法改变通知，表示之后会使用【会话秘钥】加密通信
  - 服务器握手结束通知，表示服务器握手阶段已经结束，并将之前发生的内容数据做摘要，供客户端校验
- 至此，TLS握手阶段结束，接下来客户端和服务器进入加密通信，完全用普通HTTP协议，不过采用【会话密匙】加密内容

##### 客户端校验数字证书的流程

- CA签发证书流程
  - 首先CA把持有者的公钥、用途、颁发者、有效时间等信息打包， 对这些信息Hash计算，得到Hash值
  - CA使用自己的私钥将Hash值加密，生成Certificate Signature，也就是CA对证书做了签名
  - 最后Certificate Signature添加在文件证书上，形成数字证书

- 客户端校验服务端数字证书过程
  - 客户端使用通用Hash算法获取Hash值H1
  - 浏览器和操作系统集成CA的公钥信息，浏览器收到证书后可以使用CA的公钥解密Certificate Signature中的内容，得到Hash值H2
  - 比较H1和H2，如果值相同，就是可信赖的证书

但是实际上，证书的验证过程中还有一个证书信任链问题，因为向CA申请的证书不是根证书签发的，而是中间商签发的。比如：baidu.com的证书..

对于三级关系的证书验证过程：
- 客户端收到baidu.com的证书，发现不是根证书，无法根据本地根证书公钥验证是否可信，就根据baidu.com证书的签发者，找到baidu证书的签发机构
- 向这个机构申请上级证书，请求到该证书是由根证书签发的，应用软件检查该软件是否有已预载于根证书清单上，有就利用根证书中公钥验证
- 如果这个上级证书可信就可以用上级证书的公钥验证baidu.com的证书

总的来说，由于用户信任根证书，所以根证书担保的baidu.com也可以被信任。 通常，操作系统一般会内置一下根证书。

多级证书是为了隔离与根证书的联系，避免根证书失守

## HTTPS的应用数据如何保证完整
TLS实现握手和记录协议两层
- TLS握手协议就是我们说的TLS四次握手过程，负责协商加密算法和生成对称密钥，后序用该密钥保护数据
- TLS记录协议负责保护数据并验证完整性和来源，对HTTP数据加密使用记录协议

TLS记录协议主要复杂消息的压缩，加密以及数据的认证。

流程：
- 先将消息分割成多个短片段，再对每个片段进行压缩
- 接下来，经过压缩的片段会被加上消息认证码（MAC值，通过hash算法生成），保证完整性和数据认证，通过附加消息认证码的MAC值，可以识别篡改。并且为了防止重放攻击，消息认证码还加上了片段的编号
- 接下来，压缩的片段加上消息认证码就一起通过对称密码进行加密
- 最后，经过加密的数据加上由数据类型、版本、压缩的长度组成的报头就是最终的报文数据

记录协议完成后，报文数据将传递到传输控制协议（TCP）层进行传输。

## HTTPS一定安全可靠嘛？
假如有假基站能够发送全部信息，这样假基站是不是就获取了全部信息？

这也就是说，客户端通过服务端发起HTTPS请求时，被假基站转发到一个中间服务器，于是客户端和中间服务器完成了TLS握手，这个中间服务器再和真正的服务端TLS握手

但是，这是有问题的，我们知道，HTTPS的安全靠的是什么？ **混合加密，摘要算法和数字签名，数字证书**

中间服务器和客户端的TLS握手是需要提供数字证书的，这个证书是无法伪造的，如果非法证书就需要人手动信任该网站了...。另一种可能是电脑中毒，被植入了中间人的证书，那这也和HTTPS没关系。


所以，**HTTPS协议本身到目前还是没有任何漏洞的**，即使进行中间人攻击，本质上也是利用了客户端的漏洞，不是HTTPS不安全

##### 为什么抓包攻击可以截取HTTPS数据
很多抓包攻击可以明文看到HTTPS数据，原理和中间服务器一样。

对应HTTPS，中间服务器需要满足：
- 作为客户端和真实服务器建立连接，服务器不会校验客户端身份。这点是正常的
- 作为服务端与真实客户端建立连接，这里必须要客户端信任服务端，不然是做不到的。也就是要获取到对应域名的私钥

中间服务器拿到私钥方式：
- 网站服务端获取
- CA处签发私钥
- 自己签发证书，但要被浏览器信任

其中抓包工具只能采用第三种方式了

##### 如何避免被抓包
1. 保证电脑不中病毒
2. 不用点击证书非法的网站
3. 通过HTTPS双向认证避免
  - 一般我们的HTTPS是单向认证的，客户端值认证了服务端的身份，服务端不检验客户端的身份
  - 如果用双向认证，服务端也会验证客户端身份。一旦验证到请求自己的客户端不可信任，就会拒绝通信。
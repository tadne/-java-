## HTTP/1.1优化

三种思路优化HTTP/1.1

- 避免发送HTTP请求
- 发送HTTP请求时，考虑如何减少请求次数
- 减少服务器的HTTP响应的数据大小

### 如何避免发送HTTP请求

1.对于一些重复性的HTTP请求，可以将请求-响应的数据缓存在本地，不用在网络获取服务器响应，提升性能

- 缓存的实现：
  
  - 客户端将第一次请求及响应数据存在磁盘，其中url为key，响应为value，两者形成映射关系，后续相同请求就先在磁盘中查找
  - 但如何保证数据一致性？
    - 服务器发送响应时估算一个过期时间，将信息放响应头中，一旦响应过期重新发送请求
    - 客户端发现响应过期就重新请求，并在Etag头部带上第一次请求的响应头部中的摘要，摘要是唯一标识响应的资源，服务器收到后会将本地资源的摘要和请求摘要对比
      - 不同说明缓存失效，服务器响应最新资源
      - 响应刷新过期时间，响应缓存

2.减少重定向请求次数

- 什么是重定向：
  
  - 服务器资源由于迁移、维护原因从url1移动到url2后，客户端不知情，继续请求uel1，服务器通过302响应码和Location头部告知客户端资源迁移url2，客户端再请求url2
  - 这样就会导致重定向越多，客户端发的HTTP请求越多，导致性能下降

3.合并请求

- 如果将多个访问小文件的请求合并为一个大请求，虽然传输的总资源一样，但减少了重复发送的HTTP头部
- HTTP/1.1是请求响应模型，如果第一个发送的请求未收到响应，后续请求不会再发送，为了防止单请求阻塞，浏览器一般同时发起多个请求，每个请求都有不同TCP连接，如果合并了请求，会减少TCP连接的数量
- 请求合并的方式
  - 对于网页中的小图片图标，可用 `CSSImageSprites`合并小图片，在根据css数据将大图片切割
  - 将小文件用webpack打包为大文件
- 合并请求就是合并资源，以大资源请求替换多个小资源请求。但是这样会导致大资源发送小变化时，要重新下载整个资源

4. 延迟发送请求

- 请求网页时，没必要获取全部资源，而是只获取当前用户看到的资源，只有下滑页面时再获取下面的资源，达到延迟发送请求的效果

### 如何减少HTTP响应的数据

HTTP的请求和响应中，通常响应的数据比较大，可以考虑催响应资源进行压缩后再发送。一般有无损压缩和有损压缩两种方式

- 无损压缩： 资源压缩后信息不被破坏，适用于文本、程序执行文件、源代码。常见的有gzip
- 有损压缩： 解压数据和原数据不同但是非常接近，适用于音视频。常见有H264、H265等

### 总结

三个方面优化HTTP/1.1

1. 避免请求的发送
   
   - 缓存储存响应页面，减少请求数量
2. 减少请求的次数
   
   - 将客户端处理的重定向请求交给代理服务器处理，减少、重定向次数
   - 将小资源合并为大资源来减少HTTP请求次数和头部重复传输，而且减少了TCP的连接数
   - 按需访问资源，只请求用户看得到的资源
3. 压缩资源，降低传输资源的大小


# 分布式基础理论

分布式系统 ：一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统

也就是一群独立计算机集合共同对外提供业务，分布式意味着可以采用更多普通计算机组成分布式集群提供服务。计算机越多，CPU、内存、储存资源越多，能处理的并发访问也越多

## 分布式的种类
1. 分布式应用和服务
   - 分布式应用和服务（微服务）：将应用和服务分层和分割，再将应用和模块进行分布式部署。提高并发、减少数据库连接、资源消耗，并能使不同应用复用共同的服务。易于扩展

2. 分布式数据和储存（分库分表）
   - 大型网站数据太多，单机无法提供足够内存，可以对数据进行分布式储存

3. 分布式优点
    - 可扩展性： 再资源和用户数较大增长的情况下，系统性能依然维持甚至提高
      - 表现：硬件环境可以为更多用户服务，响应更快
      - 通过增加更多、更快的处理器可以实现更可靠、完善的服务
    - 高性能：分布式系统中各个组成部分可以再并发时被执行，复杂问题被拆解为多个简单小问题，提升系统的吞吐
      - 多个用户同时访问（更新）资源
      - 多个服务同时运行、相互协作
    - 高可用：服务器系统崩溃不会影响其他服务器，保障系统高可用

4. 分布式缺点
    - 复杂度高：分布在多台服务器上，出现故障排查和诊断难度高
    - 成本高：运维和硬件成本上增高，服务器间要通过网络通信，网络基础设置问题包括传输、负载、信息丢失等
    - 服务可用性要求高： 分布式不在同一机器，要实现分布式数据一致性和服务可用性。这个过程是通过网络传输，网络存在复杂状态，尤其弱网或断网情况。导致这个难度非常大，要在数据一致性和可用性上做平衡

## CAP理论

### CAP介绍
CAP理论： 一个分布式系统最多同时满足一致性、可用性、分区容错性三项中的两项

- 一致性： 更新操作成功并返回客户端后，所有节点在同一时间数据一致
- 可用性： 服务一直可用，是正常响应时间
- 分区容错性：分布式系统在遇到某个节点或网络分区故障时，还能对外提供满足一致性和可用性的服务

## CAP权衡
### CA
这种情况不存在分布式下系统中，因为对于分布式系统，网络分区是必然的。如果舍弃网络分区那就是单体系统，没有讨论CAP的必要了

### CP
网络故障或消息丢失情况下，数据不保存一致，那么系统就不可用。也就是**牺牲用户体验，等待数据一致**再让用户访问系统。

### AP
一旦网络问题，节点就会失联。为了高可用，要用户访问时马上放回信息，那么**节点必须要有本地数据存储**。这样就一定会有数据不一致的情况。

## 总结
无论是CP还是AP都要结合业务考虑，基础数据、涉及钱财，一般要CP不保证一致性。其他场景一般用AP权衡性能，用最终一致性保证安全

## BASE理论
BASE理论是对CAP理论的延伸，核心思想是即使无法做到强一致性，但是应用可以采用合适的方式可以做到最终一致性。

BASE：（Basically Available）基本可用、软状态（ Soft State）、最终一致性（ Eventual Consistency）。

### 基本可用（Basically Available）
基本可用： 分布式系统出现故障时，运行损失部分可用性，即保证核心可用
如： 双11时，为应对核心应用访问量激增，部分用户可能会被引导到降级页面，部分服务层可能只提供降级服务，这是损失部分可用性的体现。

### 软状态（ Soft State）
软状态：系统存在中间状态，该状态不会影响系统整体可用性
软状态本质是一种弱一致性，允许的软状态不能违背“基本可用”的要求。如分布式储存一般一份数据至少有三个副本，允许不同节点间副本同步的延时。

### 最终一致性（ Eventual Consistency）
数据的所有副本在经过一定时间后，最终可以达到一致的状态

软状态的目标就是最终一致性。比如：分布式村出纳的副本数量最终会到达稳定状态。DNS就是一个典型的最终一致性系统。

最终一致性的表现形式：
- 因果一致性：如果进程A在更新完某个数据后通知了B，那么B对该数据的访问都应该能获取到A更新后的最新值，且如果B要对数据进行更新，务必基于进程A的最新值，即**不能发生丢失更新的情况**。与此同时，进程A无因果关系的进程C的数据访问没有这样的限制

- 读己之所写：会话一致性将系统数据的访问过程框定在一个会话中，系统能保证在同一个有效会话中实现“读己之所写”的一致性。也就是说，**客户端能在同一会话中始终读取到数据的最新值**。

- 单调读一致性：一个进程从系统中读取一个数据的值后，那系统对于该进程后续的数据访问都不该返回更旧的值。

- 单调写一致性：一个系统要保证同一个进程的写操作被顺序执行。

实践中可以将若干个变种结合起来，构建一个有最终一致性的分布式系统。著名的有2PC（二阶段提交协议）、3PC（三阶段提交协议）、Paxos算法、ZAB协议、RAFT协议、Gossip协议等

### 总结
BASE理论面向的是大型高可用高扩展分布式系统，和传统事务的ACID特性相反，不同与ACID强一致性模型，而是提出**牺牲强一致性获得可用性**，允许数据在一段时间内不一致，但最终达到一致状态。但要注意不同的业务和组件对数据一致性的要求不同。
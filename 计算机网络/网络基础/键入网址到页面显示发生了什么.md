# 浏览器键入网址到页面显示发生了什么

  ## 浏览器第一步工作： 解析URL生成请求信息
  - 对URL进行解析，生成发送给wev服务器的请求信息
  - url组成： 
    - “http:”       = 访问数据的协议
    - “//”          = 后面的字符串表示服务器的名称
    - “Web服务器”   
    - “/ + 目录 + / + ... + 文件名”  = 数据源文件的路径名 
    - 注： 当没有路径名的时候，会访问默认文件，如/index.html
  - 生成HTTP请求信息
    - 请求报文： 请求行（方法，url，版本号），消息头（一些键值对），消息体（数据）
    - 响应报文： 状态行（版本，状态码，短语），消息头（一些键值对），消息体（数据）
## 第二步工作： DNS服务器解析查询目标IP
  - 浏览器生成请求信息后会委托操作系统发给web服务器，但是发送前需要查询服务器域名对应的IP地址。DNS服务器就是专门保存web服务器域名和IP对应关系的服务器
    - DNS的域名都是用句点分割，句点表示不同层次间的界限，越靠右层级越高，其中最后的点表示根域名，如“.com”。也及时.根域是在最顶层，它的下一层是“.com”顶级域 
    - 根DNS服务器"."，顶级域DNS服务器".com",权威DNS服务器"server.com"
    - 这样一来，任何DNS服务器都靠右找到根服务器再到目标DNS服务器了
  - 域名解析流程
    - 客户端发出DNS请求，询问 www.server.com 的IP是啥，然后发给本地DNS服务器
    - 本地服务器接受到请求后，在缓存中找到就直接返回，没找见就访问根服务器。根服务器返回对应下级服务器，本地服务器再去访问下级服务器...
    - 最终本地DNS将IP返回给客户端，客户端和目标建立连接
## 第三步工作 协议栈传输HTTP请求
  - 客户端获取IP后，就将HTTP传输工作交给操作系统中的协议栈
  - 流程： 
    - 浏览器通过调研Socket库委托协议栈工作
    - 协议栈分为两部分，
      - 上半部分两块，
        - 分别负责收发数据的TCP和UDP协议，两个传输协议会接受应用层委托执行收发数据操作
      - 下半部分，
        - 是用IP协议控制网络包收发操作，在互联网传输数据时，数据会被分块，将数据块发送给对方的操作由IP负责
        - 其中IP还包括 ICMP协议和ARP协议
          - ICMP用于告知网络包传送中产生的错误和控制信息
          - ARP 用于根据IP查询相应以太网的MAC地址 
    - 然后网卡驱动程序负责控制网卡硬件，网卡服务负责实际收发操作。也就是对网线中信号执行发送和接受操作
## 可靠传输-TCP
  - HTTP是基于TCP协议传输的
    - TCP：　
      - TCP报文头部的格式：
        - 源端口和目标端口，加上包的序号。再有确认好来确认对方是否收到。
        - 再有一些状态位，如SYN发起连接，ack回复，rst重新连接，fin结束连接，维护连接状态
        - 窗口大小：做流量控制，标识处理能力，表示被发太快或太慢
        - 拥塞控制：根据网络控制发送速度
      - HTTP传输数据前，建立TCP连接，三次握手
        - 服务端监听端口进入LISTEN
        - 客户端发送syn进入syn_sent
        - 服务端收到后进入syn_rcvd，服务端返回ack和自己的syn
        - 客户端收到后返回ack进入ESTABLISHED
        - 服务端收到后也进入ESTABLISHED 
      - Linux可以使用netstat -napt命令查看TCP的连接状态
      - 如果HTTP请求消息超过MSS长度，TCP就要将HTTP的数据拆分多次发送
        - MTU ： IP头，TCP头，数据 。一般为1500字节
        - MSS ： MTU中数据部分的大小。叫做一个网络包能容纳的TCP数据的最大长度
        - 数据被以MSS长度为单位拆分，拆分后单独放入网络包中，也就是加上TCP头信息，再由IP模块来发送数据
    - TCP报文生成
      - TCP协议有两个端口，一个是浏览器监听80端口，一个是Web服务器监听443端口。
      - 建立连接后，TCP报文中数据部分为存在HTTP头+数据，组装好TCP后，要交给网络层处理 
## 远程定位-IP
- TCP模块在执行连接、收发、断开等操作时，都要委托IP模块将数据封装为网络包发给通信对象
- IP报文头部格式
  - 源IP和目标IP，在IP包头的协议号填写06表示协议为TCP
  - 有多个网卡要判断到底写哪个地址，这就根据路由表规则来判断
  - Linux中可以使用 route -n命令查看当前系统的路由表

## ARP两点传输-MAC
- 生成IP头部后，网络包还要加MAC头部
- MAC头部是以太网使用的头部，包含了接收方和发送方的MAC地址信息
  - MAC包头里要发送方MAC地址和接受方MAC地址，用于两点传输
    - 0800：IP协议
    - 0806：ARP协议
  - MAC发送和接受方的确认
    - 发送方：MAC地址是在网卡生产时写入ROM中的，只要将这个值读取到MAC头中即可
    - 接受方：要告诉以太网对方的MAC地址，以太网会帮忙将包发送过去
      - 通过ARP协议获取对方MAC地址： ARP在以太网广播，根据IP找MAC
        如果在同一子网中，就可以成功获取。后续会将该查询结果放到ARP缓存中以后使用
      - 也就是发包时会先查询ARP缓存，再广播
  - Linux中可以使用 arp -p 来查询ARP缓存的内容

## 第四步操作 网卡物理传输数据
- 网络包只是内存中的二进制，没法直接发，要转换为电信号才能在网线上传输。也就是说这才是真正数据的发送过程
- 负责这操作的是网卡，控制网卡要靠网卡驱动程序
- 网卡驱动获取网络包后，会将其复制到网卡缓存区，并在其开头加报头和起始帧分界符，在末尾加检查错误的帧校验序列
  - 起始帧分界符：一个用来表示包起始位置的标记
  - 末尾的FCS（帧校验序列）：用来检查包传输过程中是否损坏
- 最终网卡将包转换为电信号，通过网线发送

## 第五步操作 交换机转发
- 交换机： 将网络包原样的转发到目的地，在MAC层工作，也叫二层网络设备
  主要是用来进行过滤和转发，连接的是局域网，利用的是MAC地址
- 交换机包接受操作
  - 电信号到达网线接口，交换机模块接收，交换机将电信号转换为数字信号
  - 通过包末尾的FCS来校验错误。没问题就放缓存区
    - 这部分操作和网卡相同，但是工作方式不同。
      - 网卡本身有MAC地址，核对收到的包的接收方的MAC地址是不是发给自己的
      - 交换机端口不核对接收方的MAC地址，直接接受所有包并存缓存区，交换机的端口不具有MAC地址
  - 包放缓存区后要查询这个包的接受方MAC地址是否在MAC地址表中存在
    - 交换机的MAC地址包含：
      - 设备的MAC地址
      - 设备连接在交换机的具体端口
        - 交换机内有一张MAC地址和网线端口映射表，收到包后将端口和MAC地址写入表中
    - 当MAC地址表找不到指定MAC地址会怎样？
      - 这可能因为有该地址的设备还没给交换机发过包或地址已被删除。这样只能将包转发到所有端口，无论如何都收到包。
      - 因为以太网本身就是将包发到网络中，只有对应接受者才能接受包，其他设备会忽略，而且也不会导致网络拥塞，因为发包后目标会作出响应，会被记入缓存
    - 两个广播地址： FF:FF:FF:FF:FF:FF  255.255.255.255
- 最后转换机将包转发到路由器

## 第六步 路由器转发
- 网络包经过交换机后，到达路由器，并在此被转发到下一个路由器或目标设备。
  路由器主要是用来寻址和转发，连接的是互联网，用的是IP地址
- 转发的原理和交换机类似，通过查表判断包转发的目标
  - 路由器是基于IP设计的，俗称三层网络设备，各个端口有MAC地址和IP地址
  - 交换机基于以太网设计，俗称二层网络设备，交换机端口没有MAC地址
- 路由器基本原理
  - 端口有MAC地址，可以成为以太网发送和接受方，而且还有IP地址。类似网卡
  - 转发包时，路由器端口接收发给自己的以太包，根据路由表查询目标，再由相应端口作为发送方发送
- 路由器包接收操作
  - 电信号到网线接口，路由器将电信号转换为数字信号，通过FCS错误校验
  - 检查MAC头部接收方MAC地址，如果是自己的旧放入接收缓存，不是就丢弃
- 查询路由表确定输出端口
  - 完成包接收后，路由器去掉包头的MAC头。因为MAC头的作用就是将包传给路由器
  - 路由器根据IP有的内容进行包转发
    - 就是将每个条目的子网掩码和IP做&运算后，得到的结果和目标地址匹配
    - 如果找不到匹配路由，就选中默认路由。子网掩码0.0.0.0的记录表示默认路由
- 路由的发送操作
  - 根据路由表的网关列判断对方地址
    - 如果网关是IP地址，那这就是目标地址，路由器继续进行转发
    - 如果网关为空，则IP头的接受方IP就是目标地址，说明到达终点
  - 找到对方IP后，用ARP协议根据IP查MAC，将结果作为接受方MAC
  并且路由器也有ARP缓存，因此也会在ARP中查询，找不到就发ARP请求
- 发送会通过交换机到下一个路由器...层层转发，最终到达
- 在网络包传输的过程中，源IP和目标IP是不会改变的，变化的一致是MAC地址，业务MAC要在两个设备间进行传输

## 第七步 服务器接收
- 数据包抵达服务器，服务器就检查MAC和IP是否符合，进一步查看协议项TCP
- 在TCP头中看序列号，是就返回ack，不是就丢弃
- 查看端口，看HTTP是否监听该端口，将包发给HTTP进程
- HTTP进程将请求的页面封装在HTTP响应报文中返回
- 客户端收到，浏览器渲染页面，再进行TCP四次挥手结束